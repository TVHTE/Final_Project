<style>

    .axis path,
    .axis line {
        fill: none;
        stroke: grey;
        stroke-width: 1;
        shape-rendering: crispEdges;
    }
    .line {
        stroke: steelblue;
        stroke-width: 2;
        fill: none;
    }

</style>



<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script> -->
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
<script src="/data/datamaps.world.min.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="https://d3js.org/d3-time-format.v2.min.js"></script>

<div id="container" style="position: relative; width: 1000px; height: 600px;"></div>
<script>

/** FUNCTIONS */

// filter the data from the dataset
function filter_JSON(json, key, value) {
    var result = [];
    json.forEach(function(val,idx,arr){
        if(val[key] == value){
            result.push(val)
        }
    })
    return result
    }

// update the graph according to selected country
function update_graph(data) {
    var color = d3.scale.ordinal().range(['red','green']);

    // scale the range of the data
    x.domain(d3.extent(data, function(d) { return d.YEAR; }));
    y.domain([0, 100]);

    line_svg.selectAll("text").remove()

    // nest the entries by country
    dataNest = d3.nest()
        .key(function(d) {return d.TYPE;})
        .entries(data);

    var result = dataNest.filter(function(val, idx, arr){
    	  return $("." + val.key).attr("fill") != "#ccc"
    	  // matching the data with selector status
    	})

    var country = line_svg.selectAll(".line")
        .data(result, function(d, i){return d.key[i]});

    country.enter().append("path")
        .attr("class", "line")
        .text(result, function(d){return d.CC})

    country.transition()
    	.style("stroke", function(d,i) { return d.color = color(d.key); })
    	.attr("id", function(d){ return 'tag'+d.key.replace(/\s+/g, '');}) // assign ID
    	.attr("d", function(d){
    		return line(d.values)
    	});

    country.exit().remove();

    line_svg.selectAll(".axis").remove();

    line_svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    var yaxis = line_svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)

    // add a label to the y axis
    line_svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - 60)
        .attr("x", 0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text('% of total energy produced')
        .attr("class", "y axis label");
    }

function update_bar(year, data_FOSL, data_REN, data){

    var type = ['Fossil', 'Renewable']
    var index = year - 1960

    var data_fosl = data_FOSL[index],
        data_ren = data_REN[index];

    var value_fosl = data_fosl['VALUE'],
        value_ren = data_ren['VALUE']
        values = [value_ren, value_fosl];

    var country = [data_fosl['CC'],data_ren['CC']]

    console.log(country, data_fosl)

    xb1.domain(country.length);
    xb.domain(type).rangeRound([0, x0.rangeBand()]);
    yb.domain([0, d3.max(values, function(d) { return d })]);

    bar_svg.selectAll(".axis").remove();

    bar_svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    var yaxis = bar_svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)

    // add a label to the y axis
    bar_svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - 60)
        .attr("x", 0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text('Percentual difference for selected year')
        .attr("class", "y axis label");

    var width = 2000

    var bar_width = width / values.length

    var bar = bar_svg.selectAll(".bars")
        .data(values)
        .enter().append("rect")
            .attr('class', 'bars')
            .attr("x", function(d, i) { return i*20; })
            .attr("y", function(d) { return y(d); })
            .attr("height", function(d) { console.log(y(d)); return 700 - y(d); })
            .attr("width", 18);

}

function type(d) {
  d.VALUE = +d.VALUE; // coerce to number
  return d;
}

/** VARIABLES */

// margin for map
var margin = {top: 50, right: 80, bottom: 40, left: 160},
    width = 1300 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

// margin for line
var margin_line = {top: 50, right: 80, bottom: 40, left: 160},
     width_line = 2000 - margin.left - margin.right,
     height_line = 800 - margin.top - margin.bottom;

var x = d3.time.scale().range([0, width]),
    y = d3.scale.linear().range([height, 0]);

var xb = d3.scale.ordinal()
    .rangeRoundBands([0, width_line], .1),
    yb = d3.scale.linear().range([height, 0]);

var xAxis = d3.svg.axis().scale(x)
    .orient("bottom").ticks(5),
    yAxis = d3.svg.axis().scale(y)
    .orient("left").ticks(5);

 // svg for line
var line_svg = d3.select("body")
    .append("svg")
        .attr('class', 'line_svg')
        .attr("width", width_line)
        .attr("height", height_line)
    .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");

var bar_svg = d3.select("body")
    .append("svg")
        .attr('class', 'bar_svg')
        .attr('width', width_line)
        .attr('height', height_line)
    .append("g")
        .attr('transform',
              "translate(" + margin.left + "," + margin.top + ")");

var color_bar = d3.scale.ordinal()
    .range(["red",'green']);


var init_year = 1960

// slider
d3.select("body").insert("p", ":first-child").append("input")
  .attr("type", "range")
  .attr("min", "1960")
  .attr("max", "2017")
  .attr("value", init_year)
  .attr("id", "year");

// parse the date / time
var parseTime = d3.time.format("%Y").parse;

// define the line
var line_REN = d3.svg.line()
    .x(function(d) { return x(d.YEAR); })
    .y(function(d) { return y(d.VALUE); });

var line = d3.svg.line()
    .x(function(d) { return x(d.YEAR); })
    .y(function(d) { return y(d.VALUE); });

queue()
    .defer(d3.json, "/data/DATA_FOSL.json")
    .defer(d3.json, "/data/DATA_REN.json")
    .defer(d3.json, "/data/META.json")
    .defer(d3.json, "/data/data_project.json")
    .await(analyze);

function analyze(error, FOSL, REN, META, DATA) {
    if(error) { console.log(error); }

    var dataset = {}

    var onlyValues = META.map(function(obj){ return obj['CLASS']; });
    var minValue = Math.min.apply(null, onlyValues),
        maxValue = Math.max.apply(null, onlyValues);

    var paletteScale = d3.scale.linear()
           .domain([minValue,maxValue])
           .range(["#EFEFFF","#02386F"]);

    // fill dataset in appropriate format
    META.forEach(function(item){
        var iso = item['CC'],
            value = item['CLASS'];
            dataset[iso] = { income_class: value, fillColor: paletteScale(value) };
        });

    console.log(dataset)

    var data_bar  = []

    // render map
    var map = new Datamap({
        element: document.getElementById('container'),
        done: function(datamap) {
            datamap.svg.selectAll('.datamaps-subunit').on('click', function(geo) {
                id = geo.id;
                data = filter_JSON(DATA,'CC',id);
                update_graph(data)

                // update data for bar_chart
                data_bar.push(data)
                console.log(data_bar)

                // delete data if clicked on and already in data_bar
                

                // use slider
                d3.select("#year").on("input", function() {
                    year = this.value
                    data_FOSL = filter_JSON(FOSL,'CC',id);
                    data_REN = filter_JSON(REN,'CC',id)
                    data = filter_JSON(DATA,'CC',id)
                    update_bar(year, data_FOSL, data_REN, data)
                });
            });
        },
        projection: 'mercator', // big world map
        // countries don't listed in dataset will be painted with this color
        fills: { defaultFill: '#F5F5F5' },
        data: dataset,
        geographyConfig: {
            borderColor: '#DEDEDE',
            highlightBorderWidth: 2,
            // don't change color on mouse hover
            highlightFillColor: function(geo) {
                return geo['fillColor'] || '#F5F5F5';
            },
            // only change border
            highlightBorderColor: '#f4f142',
            // show desired information in tooltip
            popupTemplate: function(geo, data) {
                // don't show tooltip if country don't present in dataset
                if (!data) { return ; }
                // tooltip content
                return ['<div class="hoverinfo">',
                    '<strong>', geo.properties.name, '</strong>',
                    '<br>Income category: <strong>', data.income_class, '</strong>',
                    '</div>'].join('');
            }
        }
    });
}



</script>
